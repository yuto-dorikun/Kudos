# Kudos 技術仕様書

## 1. プロダクトコンセプト

### 1.1 ビジョン
**「ありがとう」が組織を強くする**

日常の小さな感謝を可視化し、組織文化として定着させることで、従業員のエンゲージメントとチームの結束力を高めるプラットフォーム。

### 1.2 解決する課題
- **リモートワークで希薄になる人間関係**
- **見えない貢献が評価されない**
- **組織の縦割りによるサイロ化**
- **従業員のモチベーション低下**

### 1.3 提供価値
- **感謝の文化醸成** - 日常的に「ありがとう」を伝える習慣
- **貢献の可視化** - 誰がどんな価値を提供しているかが見える
- **組織の一体感** - 部署を超えた感謝のやり取り
- **ポジティブな職場** - 認め合う文化で心理的安全性向上

### 1.4 MVP機能スコープ
```
[MVP必須機能]
- 感謝メッセージの送受信
- いいね機能
- 組織階層管理（支社/部署/課）
- ユーザー管理
- 基本的な表示機能（タイムライン、個人履歴）
- Devise認証システム
```

## 2. システムアーキテクチャ

### 2.1 MVP構成（Phase 1）
```
┌─────────────────────────────────────────┐
│           ユーザー（ブラウザ）            │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│          Rails Application              │
│  ┌──────────────┐  ┌─────────────────┐ │
│  │   Hotwire    │  │   Tailwind CSS  │ │
│  │ (Turbo/Stim) │  │                 │ │
│  └──────────────┘  └─────────────────┘ │
│  ┌──────────────────────────────────┐   │
│  │        Business Logic             │   │
│  │  - Devise認証                      │   │
│  │  - マルチテナント管理              │   │
│  │  - 感謝メッセージ処理              │   │
│  │  - 組織構造管理                    │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│              PostgreSQL                 │
│            永続化データ                   │
└─────────────────────────────────────────┘
```

### 2.2 スケールアップ構成（Phase 2 - 将来拡張）
```
※ユーザー数増加、パフォーマンス要求が高まった時点で導入

┌─────────────────────────────────────────┐
│           ユーザー（ブラウザ）            │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│          Rails Application              │
│  ┌──────────────────────────────────┐   │
│  │   + Redis（キャッシュ層）          │   │
│  │   + Sidekiq（非同期処理）          │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
         ↓            ↓           ↓
┌──────────────┐ ┌─────────┐ ┌──────────┐
│  PostgreSQL  │ │  Redis  │ │ Sidekiq  │
│              │ │         │ │          │
│ 永続化データ  │ │ キャッシュ│ │非同期処理 │
└──────────────┘ └─────────┘ └──────────┘
```

### 2.3 マルチテナントアーキテクチャ
```
単一DB、Row Level Securityでデータ分離

     [Application Server]
            ↓
     [PostgreSQL DB]
    ┌──────────────┐
    │  組織A データ  │ ← organization_id = 1
    ├──────────────┤
    │  組織B データ  │ ← organization_id = 2
    ├──────────────┤
    │  組織C データ  │ ← organization_id = 3
    └──────────────┘
    
全クエリに自動的にorganization_idフィルタ適用
```

## 3. データベース設計

### 3.1 設計思想

#### **シンプル & 拡張可能**
MVPは最小構成で始めるが、将来の機能追加を妨げない設計。統計機能やAI分析に必要なデータ構造を最初から考慮。

#### **セキュアなマルチテナント**
組織間のデータを完全分離。一つのミスでも他組織のデータが漏れない仕組み。

#### **パフォーマンス重視**
適切なインデックス配置、カウンターキャッシュ活用、N+1問題の回避設計。

### 3.2 データモデル全体像

```
【認証】
users（Deviseベース）
    ↓
sessions（Devise管理）

【組織構造】
organizations（会社）
    ↓
offices（支社/拠点）
    ↓
departments（部署）
    ↓
sections（課/チーム）
    ↓
users（ユーザー）

【感謝の流れ】
users → appreciations ← users
(送信者)              (受信者)
           ↓
    appreciation_likes
       (いいね)

【補助テーブル】
- organization_settings（組織別設定）
- activities（全アクティビティログ）
```

### 3.3 主要テーブル詳細

#### **organizations（組織）**

**役割**: SaaSのテナント単位。各企業・団体を表す最上位エンティティ。

| カラム | 型 | 制約 | 説明 |
|-------|---|------|------|
| id | bigint | PK | |
| name | string | NOT NULL | 会社名 |
| created_at | datetime | | |

**将来の拡張予定**:
- `subdomain` - 組織別URL（toyota.kudos.com）
- `plan_type` - 料金プラン
- `settings` (JSONB) - 柔軟な設定保存

---

#### **offices（支社/事業所）**

**役割**: 組織の物理的な拠点。地理的な区分けに使用。

| カラム | 型 | 制約 | 説明 |
|-------|---|------|------|
| id | bigint | PK | |
| organization_id | bigint | FK, NOT NULL | どの会社か |
| name | string | NOT NULL | 東京本社、大阪支社など |
| address | string | | 住所 |
| is_headquarters | boolean | DEFAULT: false | 本社フラグ |

**設計ポイント**:
- 小規模組織は本社1つだけでもOK
- 大企業は複数拠点を登録可能

---

#### **departments（部署）** & **sections（課）**

**役割**: 組織の論理的な区分け。誰がどのチームに属するかを管理。

**departments（部署）**:
| カラム | 型 | 説明 |
|-------|---|------|
| office_id | FK | どの支社の部署か |
| name | string | 営業部、開発部など |
| manager_id | FK(users) | 部長（NULL可） |

**sections（課）**:
| カラム | 型 | 説明 |
|-------|---|------|
| department_id | FK | どの部署の課か |
| name | string | 第一営業課など |
| manager_id | FK(users) | 課長（NULL可） |

**設計ポイント**:
- manager_idはNULL許容（組織構造を先に作れる）
- 階層は固定だが、使わない階層はNULLでスキップ可能

---

#### **users（ユーザー）**

**役割**: システムの中心エンティティ。全ての活動の主体。Deviseで認証管理。

| カラム | 型 | 説明 | なぜ必要？ |
|-------|---|------|-----------|
| **Devise標準カラム** | | | |
| email | string | メールアドレス | ログインID（Devise） |
| encrypted_password | string | 暗号化パスワード | Devise認証 |
| reset_password_token | string | パスワードリセット | Devise機能 |
| remember_created_at | datetime | Remember me | Devise機能 |
| sign_in_count | integer | ログイン回数 | Devise追跡 |
| current_sign_in_at | datetime | 最終ログイン | Devise追跡 |
| **基本情報** | | | |
| organization_id | FK | 所属組織 | マルチテナント分離 |
| first_name/last_name | string | 氏名 | 表示用 |
| employee_id | string | 社員番号 | 既存システム連携 |
| **所属情報** | | | |
| office_id | FK, NULL | 所属支社 | 組織構造（NULL可） |
| department_id | FK, NULL | 所属部署 | 組織構造（NULL可） |
| section_id | FK, NULL | 所属課 | 組織構造（NULL可） |
| position | string | 役職 | 課長、部長など |
| **権限** | | | |
| role | integer | 0:一般, 1:管理者 | システム権限 |
| status | integer | 0:無効, 1:有効 | 退職者の扱い |
| **その他** | | | |
| hire_date | date | 入社日 | 勤続年数分析 |
| bio | text | 自己紹介 | プロフィール |

**複合ユニーク制約**:
- `[organization_id, employee_id]` - 組織内で社員番号は一意

**設計ポイント**:
- Devise標準機能で認証・セッション管理
- 組織構造への所属は全てNULL可（フリーランスや役員対応）
- statusで退職者も論理削除（過去データ保持）

---

#### **appreciations（感謝メッセージ）**

**役割**: システムのコアバリュー。誰が誰にどんな感謝を伝えたか。

| カラム | 型 | 説明 | なぜ必要？ |
|-------|---|------|-----------|
| organization_id | FK | 組織 | データ分離 |
| sender_id | FK(users) | 送信者 | 誰から |
| receiver_id | FK(users) | 受信者 | 誰へ |
| category | integer | カテゴリ（enum） | 分類・分析用 |
| message | text | 本文 | メインコンテンツ |
| is_anonymous | boolean | 匿名フラグ | 心理的安全性 |
| likes_count | integer | いいね数 | パフォーマンス |
| created_at | datetime | 作成日時 | タイムライン |

**categoryのenum定義**:
```ruby
enum category: {
  thanks: 0,        # ありがとう
  excellent: 1,     # 素晴らしい
  helpful: 2,       # 助かりました
  learning: 3,      # 勉強になりました
  teamwork: 4,      # チームワーク
  creative: 5,      # クリエイティブ
  leadership: 6,    # リーダーシップ
  problem_solving: 7 # 問題解決
}
```

**インデックス**:
- `organization_id` - 組織別取得
- `sender_id`, `receiver_id` - ユーザー別取得
- `category` - カテゴリ別集計
- `created_at` - 期間指定、ソート

**設計ポイント**:
- categoryはenumで管理（高速、型安全、スコープ自動生成）
- likes_countはカウンターキャッシュ（高速表示）
- 将来的に`is_public`、`point_value`等の追加が容易

---

#### **appreciation_likes（いいね）**

**役割**: 共感を示すリアクション。エンゲージメント指標。

| カラム | 型 | 説明 |
|-------|---|------|
| appreciation_id | FK | どのメッセージへ |
| user_id | FK | 誰が |

**複合ユニーク制約**:
- `[appreciation_id, user_id]` - 1人1いいねまで

---

#### **activities（アクティビティログ）**

**役割**: 全ての行動を記録。分析・監査・通知の基盤。

| カラム | 型 | 説明 | 使用例 |
|-------|---|------|-------|
| organization_id | FK | 組織 | |
| user_id | FK | 実行者 | |
| action | string | 行動種別 | sent_appreciation |
| trackable_type | string | 対象モデル | Appreciation |
| trackable_id | bigint | 対象ID | 12345 |

**ポリモーフィック関連**で将来の拡張に対応

---

#### **organization_settings（組織設定）**

**役割**: 組織ごとのカスタマイズ設定。

| カラム | 型 | デフォルト | 説明 |
|-------|---|-----------|------|
| organization_id | FK, UNIQUE | | 1組織1レコード |
| allow_anonymous | boolean | true | 匿名送信許可 |
| notification_enabled | boolean | true | 通知ON/OFF |
| max_appreciations_per_day | integer | 10 | 送信数制限 |

### 3.4 データの流れ（ユースケース）

#### MVP段階（同期処理）
```sql
1. ユーザーがメッセージ作成
   INSERT INTO appreciations (sender_id, receiver_id, category, message...)
   
2. アクティビティ記録（同期）
   INSERT INTO activities (action: 'sent_appreciation'...)
   INSERT INTO activities (action: 'received_appreciation'...)
   
3. 通知送信（同期）
   ActionMailer::Base.mail(...).deliver_now
   
4. いいねが付く
   INSERT INTO appreciation_likes (user_id, appreciation_id)
   UPDATE appreciations SET likes_count = likes_count + 1
```

#### Phase2（Redis/Sidekiq導入後）
```ruby
# 非同期処理への移行
AppreciationMailer.notification(...).deliver_later  # Sidekiqで処理
Rails.cache.fetch("user_#{id}_stats") { ... }      # Redisでキャッシュ
```

### 3.5 パフォーマンス設計

#### インデックス戦略
```sql
-- 頻繁な検索条件
CREATE INDEX idx_appreciations_organization_id ON appreciations(organization_id);
CREATE INDEX idx_appreciations_sender_id ON appreciations(sender_id);
CREATE INDEX idx_appreciations_receiver_id ON appreciations(receiver_id);
CREATE INDEX idx_appreciations_category ON appreciations(category);

-- ソート条件
CREATE INDEX idx_appreciations_created_at ON appreciations(created_at DESC);

-- 複合ユニーク
CREATE UNIQUE INDEX idx_users_org_employee ON users(organization_id, employee_id);
CREATE UNIQUE INDEX idx_likes_appreciation_user ON appreciation_likes(appreciation_id, user_id);
```

#### カウンターキャッシュ
- `appreciations.likes_count` - JOINなしでいいね数表示

#### クエリ最適化例
```ruby
# N+1を避ける
Appreciation.includes(:sender, :receiver, :appreciation_type)
            .where(organization_id: current_org)
            .order(created_at: :desc)
```

## 4. セキュリティ設計

### 4.1 認証システム（Devise）

#### Devise設定
```ruby
# config/initializers/devise.rb
Devise.setup do |config|
  config.authentication_keys = [:email]
  config.case_insensitive_keys = [:email]
  config.strip_whitespace_keys = [:email]
  config.skip_session_storage = [:http_auth]
  config.stretches = Rails.env.test? ? 1 : 12
  config.password_length = 8..128
  config.reset_password_within = 6.hours
  config.sign_out_via = :delete
end
```

#### セキュリティ機能
- **パスワード暗号化**: bcryptで安全にハッシュ化
- **セッション管理**: セキュアなCookie管理
- **パスワードリセット**: トークンベースの安全なリセット
- **Remember me**: 安全な永続ログイン
- **ログイン履歴**: 不正アクセス検知

### 4.2 マルチテナントセキュリティ

#### データ分離の仕組み
```ruby
# ApplicationController
before_action :authenticate_user!  # Devise認証
before_action :set_current_organization

# 全モデルの基底
class ApplicationRecord < ActiveRecord::Base
  default_scope { where(organization_id: Current.organization_id) }
end
```

#### 脅威と対策
- **組織間データ漏洩** → default_scopeで自動フィルタ
- **権限昇格** → roleベースのアクセス制御
- **SQLインジェクション** → Strong Parameters使用
- **CSRF攻撃** → Rails標準のCSRF対策
- **セッションハイジャック** → HTTPSとセキュアCookie

### 4.3 個人情報保護
- パスワード: Devise（bcrypt）でハッシュ化
- 通信: SSL/TLS必須
- セッション: 暗号化Cookieストア（MVP）→ Redis（Phase2）

## 5. 開発ガイドライン

### 5.1 技術スタック
```yaml
言語/FW:
  Ruby: 3.3.3
  Rails: 7.2.2
  
認証:
  Devise: ~> 4.9
  
テスト:
  Minitest: Rails標準
  
データベース:
  PostgreSQL: 15+
  Redis: 7.0+（Phase2で導入）
  
フロントエンド:
  Hotwire (Turbo + Stimulus)
  Tailwind CSS
  
非同期処理:
  Sidekiq: 7.2+（Phase2で導入）
  
インフラ:
  Docker & Docker Compose
  GitHub Actions (CI/CD)
```

### 5.2 開発環境セットアップ
```bash
# 1. リポジトリクローン
git clone https://github.com/your-org/kudos.git

# 2. Ruby環境
rbenv install 3.3.3
rbenv local 3.3.3

# 3. 依存関係インストール
bundle install

# 4. Docker起動（PostgreSQLのみ）
docker-compose up -d postgres

# 5. DB初期化
rails db:setup

# 6. テスト実行
rails test

# 7. アクセス
rails server
open http://localhost:3000
```

### 5.3 ディレクトリ構造
```
kudos/
├── app/
│   ├── models/          # データモデル
│   ├── controllers/     # リクエスト処理
│   ├── views/          # UI テンプレート
│   ├── jobs/           # 非同期処理（Phase2）
│   └── mailers/        # メール送信
├── db/
│   ├── migrate/        # マイグレーション
│   └── seeds.rb        # 初期データ
├── config/
│   ├── routes.rb       # ルーティング
│   └── initializers/
│       └── devise.rb   # Devise設定
├── test/               # Minitestテスト
│   ├── models/
│   ├── controllers/
│   ├── system/         # システムテスト
│   └── test_helper.rb
└── docker-compose.yml  # 開発環境
```

### 5.4 テスト戦略（Minitest）

#### テストピラミッド
```
         ╱╲
        ╱  ╲       システムテスト（E2E）
       ╱    ╲      - 主要ユーザーフロー
      ╱──────╲     - Capybaraで実装
     ╱        ╲    
    ╱          ╲   統合テスト
   ╱            ╲  - コントローラテスト
  ╱              ╲ - API応答確認
 ╱________________╲
╱                  ╲ユニットテスト
                     - モデルテスト
                     - バリデーション
                     - ビジネスロジック
```

#### テストコード例
```ruby
# test/models/appreciation_test.rb
class AppreciationTest < ActiveSupport::TestCase
  test "should not save without sender" do
    appreciation = Appreciation.new(receiver: users(:john))
    assert_not appreciation.save
  end
  
  test "should belong to organization" do
    appreciation = appreciations(:one)
    assert_equal organizations(:acme), appreciation.organization
  end
end

# test/system/appreciations_test.rb
class AppreciationsTest < ApplicationSystemTestCase
  test "creating an appreciation" do
    sign_in users(:alice)
    visit appreciations_url
    click_on "New Appreciation"
    
    select "John Doe", from: "Receiver"
    fill_in "Message", with: "Great job on the presentation!"
    click_on "Send"
    
    assert_text "Appreciation sent successfully"
  end
end
```

### 5.5 段階的導入計画

#### Phase 1: MVP（1-2ヶ月）
- 基本機能実装
- Devise認証
- PostgreSQLのみ
- 同期処理のみ
- Minitestでテスト

#### Phase 2: スケールアップ（3-4ヶ月後）
- Redis導入（キャッシュ、セッション）
- Sidekiq導入（非同期メール、集計）
- パフォーマンスチューニング
- 監視・ログ強化

#### Phase 3: エンタープライズ（6ヶ月後）
- SSO対応（SAML、OAuth）
- API公開
- 高度な分析機能
- マルチリージョン対応