<div class="bg-white rounded-lg border border-gray-200">
  <% offices.each do |office| %>
    <% office_icon = '<svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>'.html_safe %>
    <%= render layout: 'toggle_section', locals: {
        section_class: "border-b border-gray-200 last:border-b-0",
        header_class: "p-4",
        icon_class: "w-4 h-4",
        icon_svg: office_icon,
        level: "3",
        title_class: "text-lg font-bold text-gray-900",
        title: office.name,
        count_class: "text-md font-medium text-gray-700",
        count: office.users.count,
        content_class: ""
    } do %>
      <div class="px-4 pb-4">
        <p class="text-sm text-gray-500 mb-4"><%= office.address %> • <%= office.users.count %>人 • <%= office.departments.count %>部署</p>
        <%= render 'users_grid', users: office.users.where(department: nil), extra_class: 'mb-6' %>

        <% office.departments.each do |dept| %>
          <%= render layout: 'toggle_section', locals: {
              section_class: "mb-6",
              header_class: "py-2 mb-3",
              icon_class: "w-4 h-4",
              level: "4",
              title_class: "text-lg font-semibold text-gray-900",
              title: dept.name,
              count_class: "text-sm font-medium text-gray-600",
              count: dept.users.count,
              content_class: ""
          } do %>
            <div class="ml-6">
              <p class="text-xs text-gray-500 mb-4">部長: <%= dept.manager&.full_name || "未設定" %> • <%= dept.sections.count %>課</p>
              <%= render 'users_grid', users: dept.users.where(section: nil) %>

              <% dept.sections.each do |section| %>
                <%= render layout: 'toggle_section', locals: {
                    section_class: "mb-4",
                    header_class: "py-2",
                    icon_class: "w-3 h-3",
                    level: "5",
                    title_class: "text-sm font-semibold text-gray-800",
                    title: section.name,
                    count_class: "text-xs font-medium text-gray-600",
                    count: section.users.count,
                    content_class: "ml-4"
                } do %>
                  <%= render 'users_grid', users: section.users %>
                <% end %>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    <% end %>
  <% end %>
</div>